---
# Synchronize assets files to the remote server and show progress
- name: Deploy assets files to the remote server use rsync
  command: >
    rsync -avz --delete --progress --chmod=ugo=rwX
    -e "ssh -p {{ vault_host_port }}"
    {{ansistrano_deploy_from}}/web/sites/default/files/
    {{vault_ssh_user}}@{{ vault_host_ip }}:{{ ansistrano_shared_path }}/web/sites/default/files/
  delegate_to: localhost
  tags:
    - deploy_assets

- name: Ensure the correct permissions for settings.live.php
  file:
    path: '{{ ansistrano_shared_path }}/web/sites/default/settings.live.php'
    mode: '0600'
  tags:
    - ideploy

- name: Ensure the correct permissions for settings.php
  file:
    path: '{{ ansistrano_release_path.stdout }}/web/sites/default/settings.php'
    mode: '0600'
  tags:
    - ideploy

# Rebuild Drupal cache
- name: Rebuild Drupal cache using Drush
  shell: |
    {{ release_drush_path }}
  args:
    chdir: '{{ release_drupal_path }}'
    executable: /bin/bash
  tags:
    - drupal

# Grant permissions before cleanup.
- name: Get list of releases to clean up
  shell: 'ls -1dt {{ project_web_releases_dir }}* | tail -n +3'
  register: old_releases
  ignore_errors: yes
  tags:
    - clean_up

- name: Ensure old releases variable is defined
  set_fact:
    old_releases_list: '{{ old_releases.stdout_lines if old_releases.stdout_lines else [] }}'
  tags:
    - clean_up

- name: Change ownership of old release files
  command: chown -R {{ vault_server_client }}:{{ vault_server_group }} {{ item }}
  with_items: '{{ old_releases_list }}'
  when: old_releases_list | length > 0
  tags:
    - clean_up

- name: Change permissions of old release files
  command: chmod -R 755 {{ item }}
  with_items: '{{ old_releases_list }}'
  when: old_releases_list | length > 0
  tags:
    - clean_up
